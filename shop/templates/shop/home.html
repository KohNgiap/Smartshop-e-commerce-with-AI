{% extends "shop/base.html" %}
{% block content %}
{% csrf_token %}

<div class="row g-4">
    <div class="col-lg-8">
        <div class="p-3 bg-white rounded shadow-sm">
            <h4 class="mb-3">Product Catalog</h4>

            <form class="d-flex gap-2" onsubmit="return false;">
                <input id="q" class="form-control" placeholder="Smart search: e.g. 'cheap wireless headphones for gym'">
                <button class="btn btn-primary" onclick="doSearch()">Search</button>
            </form>

            <div id="searchResults" class="mt-3"></div>

            <hr />
            <div class="row row-cols-1 row-cols-md-3 g-3">
                {% for p in products %}
                <div class="col">
                    <div class="card h-100">
                        {% if p.image %}
                        <img src="{{ p.image.url }}" class="card-img-top" style="height:160px; object-fit:cover;">
                        {% endif %}
                        <div class="card-body">
                            <h6 class="card-title">{{ p.name }}</h6>
                            <div class="text-muted small">{{ p.category }}</div>
                            <div class="fw-bold mt-1">${{ p.price }}</div>
                            <a class="btn btn-sm btn-outline-dark mt-2" href="/products/{{ p.id }}/">View</a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

        </div>
    </div>

    <div class="col-lg-4">
        <div class="p-3 bg-white rounded shadow-sm">
            <h4 class="mb-3">Recommended for You (AI)</h4>
            {% if recommended %}
            {% for p in recommended %}
            <div class="d-flex gap-2 align-items-start mb-3">
                {% if p.image %}
                <img src="{{ p.image.url }}" style="width:60px;height:60px;object-fit:cover;border-radius:10px;">
                {% else %}
                <div style="width:60px;height:60px;border-radius:10px;background:#f1f1f1;"></div>
                {% endif %}
                <div>
                    <div class="fw-semibold">{{ p.name }}</div>
                    <div class="text-muted small">{{ p.category }} • ${{ p.price }}</div>
                    <a class="small" href="/products/{{ p.id }}/">Open</a>
                </div>
            </div>
            {% endfor %}
            {% else %}
            <div class="text-muted">Log in + browse products to get personalized recommendations.</div>
            {% endif %}
        </div>

        <div class="p-3 bg-white rounded shadow-sm mt-4">
            <h4 class="mb-2">Virtual Assistant</h4>
            <textarea id="chatMsg" class="form-control" rows="3"
                placeholder="Ask: 'Suggest a gift under $50'"></textarea>
            <button class="btn btn-success mt-2" onclick="chat()">Ask</button>
            <div id="chatReply" class="mt-3 small"></div>
        </div>
    </div>
</div>

<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(";");
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + "=")) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie("csrftoken");


    async function doSearch() {
        const q = document.getElementById("q").value.trim();
        if (!q) return;

        const res = await fetch(`/api/search/?q=${encodeURIComponent(q)}`);
        const data = await res.json();

        const box = document.getElementById("searchResults");
        box.innerHTML = `<div class="mb-2 fw-semibold">Search Results</div>`;
        if (!data.results || data.results.length === 0) {
            box.innerHTML += `<div class="text-muted">No results</div>`;
            return;
        }

        box.innerHTML += data.results.map(p => `
    <div class="border rounded p-2 mb-2 bg-light">
      <div class="fw-semibold">${p.name}</div>
      <div class="text-muted small">${p.category} • $${p.price}</div>
      <a class="small" href="/products/${p.id}/">Open</a>
    </div>
  `).join("");
    }

    async function chat() {
        const msg = document.getElementById("chatMsg").value.trim();
        if (!msg) return;

        const res = await fetch("/api/chat/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrftoken
            },
            body: JSON.stringify({ message: msg })
        });

        let data = {};
        try { data = await res.json(); } catch (e) { }

        document.getElementById("chatReply").innerText =
            data.reply || data.error || "No reply";
    }

</script>

{% endblock %}