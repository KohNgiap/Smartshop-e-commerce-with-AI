{% extends "shop/base.html" %}
{% block content %}
{% csrf_token %}


<div class="row g-4">
    <div class="col-lg-5">
        <div class="bg-white rounded shadow-sm p-3">
            {% if product.image %}
            <img src="{{ product.image.url }}" alt="{{ product.name }}">
            {% else %}
            <div class="text-muted small">No image uploaded.</div>
            {% endif %}

            <h3 class="mt-3">{{ product.name }}</h3>
            <div class="text-muted">{{ product.category }}</div>
            <div class="fs-4 fw-bold mt-2">${{ product.price }}</div>
            <div class="small mt-2"><b>Tags:</b> {{ product.tags }}</div>
            {% if product.short_description %}
            <div class="mt-2">{{ product.short_description }}</div>
            {% endif %}
        </div>
    </div>

    <div class="col-lg-7">
        <div class="bg-white rounded shadow-sm p-3 mb-4">
            <h4>AI Dynamic Description</h4>
            <button class="btn btn-primary btn-sm" onclick="genDesc()">Generate</button>
            <pre id="aiDesc" class="mt-3 small" style="white-space:pre-wrap;">{{ product.ai_description }}</pre>
        </div>

        <div class="bg-white rounded shadow-sm p-3 mb-4">
            <h4>Customer Reviews</h4>
            {% for r in reviews %}
            <div class="border rounded p-2 mb-2">
                <div class="fw-semibold">{{ r.rating }}/5</div>
                <div class="small">{{ r.text }}</div>
            </div>
            {% empty %}
            <div class="text-muted">No reviews yet.</div>
            {% endfor %}

            <hr />
            <h4>AI Review Summary</h4>
            <button class="btn btn-success btn-sm" onclick="sumReviews()">Summarize</button>
            <pre id="aiSum" class="mt-3 small" style="white-space:pre-wrap;">{{ product.ai_review_summary }}</pre>
        </div>
    </div>
</div>

<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(";");
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + "=")) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const csrftoken = getCookie("csrftoken");

    async function genDesc() {
        const el = document.getElementById("aiDesc");
        el.innerText = "Generating...";

        const res = await fetch(`/api/products/{{ product.id }}/generate-description/`, {
            method: "POST",
            headers: {
                "X-CSRFToken": csrftoken,
                "Content-Type": "application/json"
            }
        });

        let data = {};
        try {
            data = await res.json();
        } catch (e) { }

        if (!res.ok) {
            el.innerText = `⚠ ${data.error || "Failed to generate description"}`;
            return;
        }

        el.innerText = data.ai_description || "⚠ Empty description returned";
    }

    async function sumReviews() {
        const el = document.getElementById("aiSum");
        el.innerText = "Summarizing...";

        const res = await fetch(`/api/products/{{ product.id }}/summarize-reviews/`, {
            method: "POST",
            headers: {
                "X-CSRFToken": csrftoken,
                "Content-Type": "application/json"
            }
        });

        let data = {};
        try {
            data = await res.json();
        } catch (e) { }

        if (!res.ok) {
            el.innerText = `⚠ ${data.error || "Failed to summarize reviews"}`;
            return;
        }

        el.innerText = data.ai_review_summary || "⚠ Empty summary returned";
    }
</script>


{% endblock %}